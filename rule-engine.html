<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Logic Studio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: 50px;
        }

        /* Modern Card Styling */
        .card-custom {
            background: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header-custom {
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
            padding: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            padding: 0.6rem 1rem;
            transition: all 0.2s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Code Editor Style */
        .code-editor {
            background-color: #1e293b;
            color: #e2e8f0;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.85rem;
            border: 1px solid #334155;
        }

        /* Result Section Styles */
        .status-banner {
            padding: 2rem;
            border-radius: var(--border-radius);
            color: white;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }
        .status-banner.approved { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .status-banner.rejected { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
        .status-banner.default { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); }

        .metric-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            height: 100%;
        }
        .metric-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 0.5rem; }
        .metric-val { font-size: 1.25rem; font-weight: 700; color: var(--text-main); }

        /* JSON Output Pre tag */
        pre.json-output {
            background: #0f172a;
            color: #38bdf8;
            padding: 1rem;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.8rem;
        }

        .btn-primary-custom {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            border-radius: 8px;
        }
        .btn-primary-custom:hover { background-color: #4338ca; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold" href="#">
            <i class="bi bi-calculator me-2"></i>CPL Logic Studio
        </a>
    </div>
</nav>

<div class="container-fluid px-lg-5">
    <div class="row g-4">
        
        <div class="col-lg-5">
            <div class="card-custom">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">Configuration</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadSampleData()">
                        <i class="bi bi-file-earmark-code me-1"></i> Load Sample
                    </button>
                </div>
                <div class="card-body p-4">
                    <form id="valuationForm">
                        
                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Case Details</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Case Type</label>
                                <select class="form-select" id="caseType">
                                    <option value="new_car">New Car</option>
                                    <option value="used_car" selected>Used Car</option>
                                    <option value="existing_car">Refinance / Existing</option>
                                    <option value="not_finalized">Not Finalized</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ownership Type</label>
                                <select class="form-select" id="commercialStatus">
                                    <option value="no">Private Individual</option>
                                    <option value="yes">Commercial</option>
                                </select>
                            </div>
                        </div>

                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Asset & Pricing</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <label class="form-label">Veh. Age (Yrs)</label>
                                <input type="number" class="form-control" id="vage" value="4">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Owner Serial #</label>
                                <input type="number" class="form-control" id="ownerNumber" value="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Fair Market Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" id="fairPrice" value="500000">
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">On Road (New)</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" id="onRoadPrice" value="800000">
                                </div>
                            </div>
                        </div>

                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Bureau Data</h6>
                        <div class="mb-4">
                            <label class="form-label d-flex justify-content-between">
                                <span>Equifax JSON Payload</span>
                                <span class="badge bg-secondary">JSON</span>
                            </label>
                            <textarea class="form-control code-editor" id="equifaxJson" rows="8" placeholder="// Paste full Equifax response object here..."></textarea>
                        </div>

                        <button type="button" class="btn btn-primary btn-primary-custom w-100 py-3 shadow-sm" onclick="runValuation()">
                            <i class="bi bi-play-fill me-1"></i> Run Logic Simulation
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div id="welcomePlaceholder" class="card-custom p-5 text-center text-muted">
                <i class="bi bi-cpu fs-1 mb-3 d-block"></i>
                <h5>Ready to Process</h5>
                <p>Configure inputs on the left and click "Run Logic Simulation"</p>
            </div>

            <div id="resultsArea" style="display:none;">
                
                <div id="mainResultBanner" class="status-banner default shadow-sm">
                    <div>
                        <h2 class="mb-0 fw-bold" id="resTitle">Processing...</h2>
                        <p class="mb-0 opacity-75" id="resSubtitle">Analyzing credit data</p>
                    </div>
                    <div class="text-end">
                        <div class="display-6 fw-bold" id="scoreDisplay">---</div>
                        <div class="small text-uppercase">Credit Score</div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card-custom h-100 p-4 border-start border-5 border-primary">
                            <h6 class="text-muted text-uppercase mb-3">Valuation Range</h6>
                            <h3 class="fw-bold text-primary mb-1" id="valAmount">₹0 - ₹0</h3>
                            <span class="badge bg-primary bg-opacity-10 text-primary" id="valPercent">0% - 0% LTV</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-custom h-100 p-4 border-start border-5 border-success">
                            <h6 class="text-muted text-uppercase mb-3">Estimated EMI</h6>
                            <h3 class="fw-bold text-success mb-1" id="emiAmount">₹0 - ₹0</h3>
                            <div class="small text-muted mt-2">
                                <i class="bi bi-clock me-1"></i> <span id="finalTenure">0</span> Months @ 
                                <i class="bi bi-percent me-1"></i> <span id="finalRate">0</span>%
                            </div>
                        </div>
                    </div>
                </div>

                <div id="rejectionSection" class="alert alert-danger shadow-sm border-0 mb-4" style="display:none;">
                    <h5 class="alert-heading fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>Application Declined</h5>
                    <hr>
                    <p class="mb-2">The following criteria were not met:</p>
                    <ul id="rejectionList" class="mb-0 fw-semibold"></ul>
                </div>

                <div class="card-custom">
                    <div class="card-header-custom">
                        <h6 class="mb-0 fw-bold"><i class="bi bi-bug me-2"></i>Logic Internals (Computed)</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row g-3">
                            <div class="col-6 col-md-4 col-xl-2">
                                <div class="metric-card">
                                    <div class="metric-label">Max DPD (3M)</div>
                                    <div class="metric-val" id="debugMaxAnyDpd3">-</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-xl-2">
                                <div class="metric-card">
                                    <div class="metric-label">Car DPD (3M)</div>
                                    <div class="metric-val" id="debugMaxCarDpd3">-</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-xl-2">
                                <div class="metric-card">
                                    <div class="metric-label">Car DPD (6M)</div>
                                    <div class="metric-val" id="debugMaxCarDpd6">-</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-xl-2">
                                <div class="metric-card">
                                    <div class="metric-label">Tenure Elig.</div>
                                    <div class="metric-val" id="debugEligibleTenure">-</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-xl-2">
                                <div class="metric-card">
                                    <div class="metric-label">Overdue</div>
                                    <div class="metric-val" id="debugOverdue">-</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-xl-2">
                                <div class="metric-card">
                                    <div class="metric-label">High Due</div>
                                    <div class="metric-val" id="debugDueCount">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion shadow-sm" id="accordionOutput">
                    <div class="accordion-item border-0 overflow-hidden" style="border-radius: var(--border-radius);">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed fw-bold bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOutput" aria-expanded="false" aria-controls="collapseOutput">
                                <i class="bi bi-code-slash me-2"></i> View Full Response Object
                            </button>
                        </h2>
                        <div id="collapseOutput" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionOutput">
                            <div class="accordion-body p-0">
                                <pre id="rawOutput" class="json-output m-0"></pre>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 1. CONSTANTS ---
    const CplConstants = {
        CPL_CAR_TYPE_NEW: 'new_car',
        CPL_CAR_TYPE_USED: 'used_car',
        CPL_CAR_TYPE_EXISTING: 'existing_car',
        CPL_CAR_TYPE_NOT_FINALIZED:'not_finalized',
        CPL_REPORT_REJECTION_REASONS : {
            OWNER_LIMIT: "OWNER_LIMIT (More than 3rd Owner)",
            COMMERCIAL_NEW: "COMMERCIAL_NEW (Comm. not eligible for New)",
            HAS_DPD_IN_3M: "HAS_DPD_IN_3M (High DPD >30 in 3M)",
            SCORE_TOO_LOW: "SCORE_TOO_LOW (Score below threshold)",
            VEHICLE_AGE_EXCEEDED: "VEHICLE_AGE_EXCEEDED",
            PAST_DUE_AMT_EXCEEDED: "PAST_DUE_AMT_EXCEEDED (>5k)",
            HAS_OVERDUE_NEW: "HAS_OVERDUE_NEW (Overdue payments)",
            CAR_DPD_3M: "CAR_DPD_3M (Active Car DPD 3M)",
            CAR_DPD_6M: "CAR_DPD_6M (Active Car DPD 6M)",
            CRITERIA_MISMATCH_UNKNOWN:"CRITERIA_MISMATCH_UNKNOWN"
        }
    };

    // --- 2. LOGIC HELPER ---
    const getDpdDays = (status) => {
        if (!status) return 0;
        const s = status.toString().trim();
        if (s === 'STD') return 1;
        if (['Current', 'XXX', '000', 'STD', 'SMA', 'LSS', 'DBT'].includes(s) === false) {
            const days = parseInt(s, 10);
            return isNaN(days) ? 0 : days;
        }
        return 0; 
    };

    // --- 3. CORE VALUATION LOGIC ---
    function carValuation(caseType, score, vehicleOwnerNumber, vage, commercialStatus, maxAnyDpd3, maxCarDpd3, maxCarDpd6, hasEligibleTenure, duecount, overdue) { 
        const REASONS = CplConstants.CPL_REPORT_REJECTION_REASONS;
        let [minval, maxval, res, tenure, rate] = [0, 0, 0, 0, 0];
        let rejectionReasons = [];

        // Basic Checks
        if (isNaN(vehicleOwnerNumber)) vehicleOwnerNumber = 1;
        if (vehicleOwnerNumber > 3) return [0, 0, 0, tenure, rate, [REASONS.OWNER_LIMIT]];
        if (vage > 15) rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);

        const commStatus = commercialStatus ? commercialStatus.toLowerCase() : 'no';
        const isCommercial = commStatus === 'yes';

        // Score Buckets
        const isScoreNull = !score || score === 0;
        const isScoreNew = score === -1 || (score >= 1 && score <= 6);
        const s751 = score >= 751;
        const s726 = score >= 726;
        const s701 = score >= 701;
        const s650_700 = score >= 650 && score <= 700;
        const isScoreLow = !s751 && !s726 && !s701 && !s650_700 && !isScoreNew && !isScoreNull;

        const isHighTenure = hasEligibleTenure; 

        // CASE 1: NEW CAR
        if (caseType === CplConstants.CPL_CAR_TYPE_NEW) {
            if (isCommercial) return [0, 0, 0, 0, 0, [REASONS.COMMERCIAL_NEW]];
            [tenure, rate] = [84, 9]; 

            if (s751) {
                if (duecount <= 0) { [minval, maxval, res] = [90, 95, 1]; }
                else rejectionReasons.push(REASONS.PAST_DUE_AMT_EXCEEDED);
            } 
            else if ((score >= 701 && score <= 750) || isScoreNew) {
                if (duecount <= 0) { [minval, maxval, res] = [80, 90, 1]; }
                else rejectionReasons.push(REASONS.PAST_DUE_AMT_EXCEEDED);
            } 
            else if (s650_700) {
                if (overdue <= 0) { [minval, maxval, res] = [70, 80, 1]; }
                else rejectionReasons.push(REASONS.HAS_OVERDUE_NEW);
            } 
            else rejectionReasons.push(REASONS.SCORE_TOO_LOW);
        }
        // CASE 2: USED CAR / NOT FINALIZED
        else if ([CplConstants.CPL_CAR_TYPE_USED, CplConstants.CPL_CAR_TYPE_NOT_FINALIZED].includes(caseType)) {
            [tenure, rate] = [60, 12]; 
            if (maxAnyDpd3 >= 30) return [0, 0, 0, tenure, rate, [REASONS.HAS_DPD_IN_3M]];

            if (!isCommercial) {
                if (s726 || isScoreNull) {
                    if (vage <= 12) { [minval, maxval, res] = [90, 100, 1]; }
                    else if (vage <= 15) { [minval, maxval, res] = [80, 90, 1]; } 
                    else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                } 
                else if ((score >= 701 && score <= 725) || isScoreNew) {
                    if (vage <= 12) { [minval, maxval, res] = [80, 90, 1]; }
                    else if (vage <= 15) { [minval, maxval, res] = [75, 85, 1]; }
                    else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                } 
                else if (s650_700) {
                    if (vage <= 12) { [minval, maxval, res] = [70, 80, 1]; }
                    else if (vage <= 15) { [minval, maxval, res] = [65, 75, 1]; }
                    else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                } 
                else {
                    rejectionReasons.push(REASONS.SCORE_TOO_LOW);
                    if (vage > 15) rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                }
            } else {
                // Commercial
                if (s726) { [minval, maxval, res] = [70, 80, 1]; }
                else if ((score >= 701 && score <= 725) || isScoreNew) { [minval, maxval, res] = [70, 80, 1]; }
                else if (s650_700) { [minval, maxval, res] = [60, 70, 1]; }
                else if (isScoreNull) {
                    if (vage <= 12) { [minval, maxval, res] = [70, 80, 1]; }
                    else if (vage <= 15) { [minval, maxval, res] = [60, 70, 1]; }
                    else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                } 
                else rejectionReasons.push(REASONS.SCORE_TOO_LOW);
                
                if (vage > 15 && !rejectionReasons.includes(REASONS.VEHICLE_AGE_EXCEEDED)) {
                    rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                }
            }
        }
        // CASE 3: EXISTING LOAN
        else if (caseType === CplConstants.CPL_CAR_TYPE_EXISTING) {
            [tenure, rate] = [60, 15]; 
            if (!isCommercial) {
                if (isHighTenure) {
                    if (maxCarDpd3 > 0) rejectionReasons.push(REASONS.CAR_DPD_3M);
                    if (s701 && !isScoreNew) {
                        if (vage <= 10) { [minval, maxval, res] = [150, 200, 1]; }
                        else if (vage <= 15) { [minval, maxval, res] = [80, 100, 1]; }
                        else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                    } 
                    else if (s650_700 || isScoreNew) {
                        if (vage <= 10) { [minval, maxval, res] = [90, 100, 1]; }
                        else if (vage <= 15) { [minval, maxval, res] = [80, 90, 1]; }
                        else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                    } 
                    else if (isScoreLow) {
                        rejectionReasons.push(REASONS.SCORE_TOO_LOW);
                        if (vage > 15) rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                    }
                } else {
                    if (maxCarDpd6 > 0) rejectionReasons.push(REASONS.CAR_DPD_6M);
                    if (s701 || isScoreNull) { 
                        if (vage <= 10) { [minval, maxval, res] = [90, 140, 1]; }
                        else if (vage <= 15) { [minval, maxval, res] = [80, 90, 1]; }
                        else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                    } else {
                        rejectionReasons.push(REASONS.SCORE_TOO_LOW);
                        if (vage > 15) rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                    }
                }
            } else {
                // Commercial Existing
                if (isHighTenure) {
                    if (maxCarDpd3 > 0) rejectionReasons.push(REASONS.CAR_DPD_3M);
                    if (s701 || s650_700 || isScoreNew) {
                        if (vage <= 10) { [minval, maxval, res] = [70, 80, 1]; }
                        else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                    } else rejectionReasons.push(REASONS.SCORE_TOO_LOW);
                } else {
                    if (maxCarDpd6 > 0) rejectionReasons.push(REASONS.CAR_DPD_6M);
                    if (s701 || isScoreNull) {
                        if (vage <= 10) { [minval, maxval, res] = [70, 80, 1]; }
                        else rejectionReasons.push(REASONS.VEHICLE_AGE_EXCEEDED);
                    } else rejectionReasons.push(REASONS.SCORE_TOO_LOW);
                }
            }
            if (rejectionReasons.includes(REASONS.CAR_DPD_3M) || rejectionReasons.includes(REASONS.CAR_DPD_6M)) {
                [minval, maxval, res] = [0, 0, 0];
            }
        }

        if (res === 0 && rejectionReasons.length === 0) {
            rejectionReasons.push(REASONS.CRITERIA_MISMATCH_UNKNOWN);
        }
        rejectionReasons = [...new Set(rejectionReasons)];
        return [minval, maxval, res, tenure, rate, rejectionReasons];
    }

    // --- 4. DATA PROCESSOR ---
    function processEquifaxData(equifaxData, vage, caseType, vehicleOwnerNumber, commercialStatus, fairPrice, onRoadPrice) {
        
        // Unwrapping Logic
        let report = equifaxData;
        if (equifaxData?.data?.reportData) report = equifaxData.data.reportData;
        else if (equifaxData?.reportData) report = equifaxData.reportData;

        // Extract Score
        let score = 0;
        if (report?.reportSummary?.creditScore?.score) {
            score = parseInt(report.reportSummary.creditScore.score) || 0;
        }

        // Aggregate Loans
        let loanDetails = [];
        if (report?.creditAnalysis?.loans) {
            const loansObj = report.creditAnalysis.loans;
            loanDetails = [
                ...(loansObj.personalLoans ?? []),
                ...(loansObj.homeLoans ?? []),
                ...(loansObj.autoLoans ?? []),
                ...(loansObj.educationLoans ?? []),
                ...(loansObj.businessLoans ?? []),
                ...(loansObj.goldLoans ?? []),
                ...(report.creditAnalysis?.otherLoans ?? []),
            ];
        }

        // Generate Dates
        const today = new Date();
        const dateKeys = Array.from({ length: 6 }, (_, i) => {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            return `${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getFullYear().toString().slice(-2)}`;
        });
        const last3Months = new Set(dateKeys.slice(0, 3));
        const last6Months = new Set(dateKeys.slice(0, 6));

        let [duecount, overdue] = [0, 0];
        let [maxAnyDpd3, maxCarDpd3, maxCarDpd6] = [0, 0, 0];
        let hasActiveCarLoanGt12m = false;
        let hasClosedCarLoanLt6m = false;
        
        const carTypes = ['Auto Loan (Personal)', 'Used Car Loan', 'P2P Auto Loan', 'Auto Loan'];

        for (const loan of loanDetails) {
            const isCar = carTypes.includes(loan?.accountType);
            const pDue = parseFloat(loan?.accountPastDueAmount || loan?.PastDueAmount) || 0; 
            if (pDue > 5000) duecount++;
            if (pDue > 0) overdue++;

            for (const hist of loan?.paymentHistory ?? []) {
                const days = getDpdDays(hist?.status); 
                if (last3Months.has(hist?.month)) {
                    if (days > maxAnyDpd3) maxAnyDpd3 = days;
                    if (isCar && days > maxCarDpd3) maxCarDpd3 = days;
                }
                if (last6Months.has(hist?.month)) {
                    if (isCar && days > maxCarDpd6) maxCarDpd6 = days;
                }
            }

            if (isCar) {
                if (loan.accountStatus === 'Open' && loan.accountOpenDate) {
                    const dOpen = new Date(loan.accountOpenDate);
                    const diff = (today.getFullYear() - dOpen.getFullYear()) * 12 + (today.getMonth() - dOpen.getMonth());
                    if (diff >= 12) hasActiveCarLoanGt12m = true;
                } 
                else if (loan.accountStatus === 'Closed' && loan.accountCloseDate) {
                    const dClose = new Date(loan.accountCloseDate);
                    const diff = (today.getFullYear() - dClose.getFullYear()) * 12 + (today.getMonth() - dClose.getMonth());
                    if (diff <= 6) hasClosedCarLoanLt6m = true;
                }
            }
        }

        const hasEligibleTenure = hasActiveCarLoanGt12m || hasClosedCarLoanLt6m;

        const [minval, maxval, res, tenure, rate, rejectionReasons] = carValuation(
            caseType, score, vehicleOwnerNumber, vage, commercialStatus,
            maxAnyDpd3, maxCarDpd3, maxCarDpd6,
            hasEligibleTenure, duecount, overdue
        );

        const basePrice = ![CplConstants.CPL_CAR_TYPE_NEW, CplConstants.CPL_CAR_TYPE_NOT_FINALIZED].includes(caseType) ? fairPrice : onRoadPrice;
        const minValuation = Math.round((basePrice * minval) / 100);
        const maxValuation = Math.round((basePrice * maxval) / 100);

        const r = rate / 12 / 100;
        const emiFactor = Math.pow(1 + r, tenure);
        const minEMI = r > 0 ? Math.round((minValuation * r * emiFactor) / (emiFactor - 1)) : 0;
        const maxEMI = r > 0 ? Math.round((maxValuation * r * emiFactor) / (emiFactor - 1)) : 0;

        return {
            output: {
                score, res, minValuation, maxValuation, minEMI, maxEMI,
                evaluate_percent: `${minval}% - ${maxval}%`,
                scoreColor: score >= 725 ? '#1BC76D' : (score >= 650 ? '#EEC000' : '#E23E44'),
                rejectionReasons: rejectionReasons.length > 0 ? rejectionReasons : null,
                finalTenure: tenure,
                finalRate: rate
            },
            debug: {
                maxAnyDpd3, maxCarDpd3, maxCarDpd6, hasEligibleTenure, duecount, overdue, dateKeysUsed: Array.from(last6Months)
            }
        };
    }

    // --- 5. UI CONTROLLER ---
    function runValuation() {
        try {
            const caseType = document.getElementById('caseType').value;
            const commercialStatus = document.getElementById('commercialStatus').value;
            const vage = parseInt(document.getElementById('vage').value) || 0;
            const ownerNumber = parseInt(document.getElementById('ownerNumber').value) || 1;
            const fairPrice = parseFloat(document.getElementById('fairPrice').value) || 0;
            const onRoadPrice = parseFloat(document.getElementById('onRoadPrice').value) || 0;
            const jsonText = document.getElementById('equifaxJson').value;

            if(!jsonText.trim()) { alert("Please paste Equifax JSON Data"); return; }
            
            const equifaxData = JSON.parse(jsonText);
            const result = processEquifaxData(equifaxData, vage, caseType, ownerNumber, commercialStatus, fairPrice, onRoadPrice);

            // Toggle views
            document.getElementById('welcomePlaceholder').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'block';

            // Populate Output
            document.getElementById('rawOutput').textContent = JSON.stringify(result, null, 2);

            const out = result.output;
            const dbg = result.debug;

            // Status Banner
            const banner = document.getElementById('mainResultBanner');
            const resTitle = document.getElementById('resTitle');
            const resSubtitle = document.getElementById('resSubtitle');

            banner.classList.remove('default', 'approved', 'rejected');
            if (out.rejectionReasons) {
                banner.classList.add('rejected');
                resTitle.textContent = "Application Rejected";
                resSubtitle.textContent = "Logic criteria mismatch found";
                document.getElementById('rejectionSection').style.display = 'block';
                
                const list = document.getElementById('rejectionList');
                list.innerHTML = "";
                out.rejectionReasons.forEach(r => {
                    const li = document.createElement('li');
                    li.textContent = r;
                    list.appendChild(li);
                });
            } else {
                banner.classList.add('approved');
                resTitle.textContent = "Application Approved";
                resSubtitle.textContent = "All logic checks passed";
                document.getElementById('rejectionSection').style.display = 'none';
            }

            // Metrics
            document.getElementById('scoreDisplay').textContent = out.score;
            document.getElementById('valAmount').innerText = `₹${out.minValuation.toLocaleString()} - ₹${out.maxValuation.toLocaleString()}`;
            document.getElementById('valPercent').innerText = out.evaluate_percent + " LTV";
            document.getElementById('emiAmount').innerText = `₹${out.minEMI.toLocaleString()} - ₹${out.maxEMI.toLocaleString()}`;
            document.getElementById('finalTenure').innerText = out.finalTenure;
            document.getElementById('finalRate').innerText = out.finalRate;

            // Debug Tiles
            document.getElementById('debugMaxAnyDpd3').innerText = dbg.maxAnyDpd3;
            document.getElementById('debugMaxCarDpd3').innerText = dbg.maxCarDpd3;
            document.getElementById('debugMaxCarDpd6').innerText = dbg.maxCarDpd6;
            document.getElementById('debugEligibleTenure').innerText = dbg.hasEligibleTenure ? "Yes" : "No";
            document.getElementById('debugOverdue').innerText = dbg.overdue;
            document.getElementById('debugDueCount').innerText = dbg.duecount;

        } catch (e) {
            alert("Error parsing JSON: " + e.message);
            console.error(e);
        }
    }

    function loadSampleData() {
        const d = new Date();
        const m = (d.getMonth() + 1).toString().padStart(2, '0');
        const y = d.getFullYear().toString().slice(-2);
        const currMonth = `${m}-${y}`;

        const sample = {
            "reportData": {
                "reportSummary": { "creditScore": { "score": "760" } },
                "creditAnalysis": {
                    "loans": {
                        "autoLoans": [
                            {
                                "accountType": "Auto Loan",
                                "accountStatus": "Open",
                                "accountOpenDate": "2021-01-15",
                                "accountPastDueAmount": "0",
                                "paymentHistory": [
                                    { "month": currMonth, "status": "000" },
                                    { "month": "11-24", "status": "000" } 
                                ]
                            }
                        ]
                    }
                }
            }
        };
        document.getElementById('equifaxJson').value = JSON.stringify(sample, null, 2);
    }
</script>

</body>
</html>